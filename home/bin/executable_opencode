#!/bin/bash
set -euo pipefail

APP="opencode"
CONTAINER="ghcr.io/burnskp/containers/opencode:latest"
VOLUME_CONFIG="$HOME/.config/containers/$APP"

# If a directory is provided as the first argument then use it as the workspace.
if [ "$#" -gt 0 ] && [[ -d $1 ]]; then
  WORKSPACE=$1
  shift
else
  WORKSPACE=$PWD
fi
PROJECT="${WORKSPACE##*/}"

mkdir -p "$VOLUME_CONFIG"

if which podman > /dev/null 2>&1; then
  podman pull "$CONTAINER"
  podman run -it \
    --userns=keep-id \
    --env COLORTERM=truecolor \
    --volume="$VOLUME_CONFIG:/home/ubuntu/.local/share/opencode" \
    --volume="$WORKSPACE:/workspace/$PROJECT" \
    "$CONTAINER" "$PROJECT" "$@"
elif which docker > /dev/null 2>&1; then
  docker pull "$CONTAINER"
  docker run -it \
    --env COLORTERM=truecolor \
    --volume="$VOLUME_CONFIG:/home/ubuntu/.local/share/opencode" \
    --volume="$WORKSPACE:/workspace/$PROJECT" \
    "$CONTAINER" "$PROJECT" "$@"
else
  echo "Error: podman or docker not found."
  exit 1
fi
