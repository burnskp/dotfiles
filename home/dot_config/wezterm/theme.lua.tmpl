local M = {}
local wezterm = require("wezterm")
local fqdn = wezterm.hostname()
local hostname = fqdn:match("([^%.]+)")

local function tab_title(tab_info)
  local title = tab_info.tab_title
  -- if the tab title is explicitly set, take that
  if title and #title > 0 then
    return title
  end
  -- Otherwise, use the title from the active pane
  -- in that tab
  return tab_info.active_pane.title
end

wezterm.on("update-status", function(window)
  window:set_right_status(wezterm.format({ { Text = " " .. window:active_workspace() .. " " } }))
end)

wezterm.on("format-tab-title", function(tab, _, _, _, _, max_width)
  local number = tostring(tab.tab_index + 1)
  local title = wezterm.truncate_right(tab_title(tab), max_width - 5)

  -- Catppuccin Latte
  local bar_background = "#e6e9ef"
  local background = "#bcc0cc"
  local foreground = "#4c4f69"
  local number_foreground = "#e6e9ef"
  local number_background
  if string.find(title, "^[0-9]: Copy mode:") then
    number_background = "#fe640b"
  elseif tab.is_active then
    number_background = "#8839ef"
  else
    number_background = "#7c7f93"
  end

  return {
    { Background = { Color = bar_background } },
    { Text = " " },
    { Background = { Color = number_background } },
    { Foreground = { Color = number_foreground } },
    { Text = " " .. number .. " " },
    { Background = { Color = background } },
    { Foreground = { Color = foreground } },
    { Text = " " .. wezterm.truncate_right(title, max_width - 5) .. " " },
  }
end)

---@param config unknown
function M.config(config)
  config.color_scheme = "Catppuccin Latte"

  config.default_workspace = hostname
  config.inactive_pane_hsb = {}
  config.show_new_tab_button_in_tab_bar = false
  config.tab_bar_at_bottom = true
  config.tab_max_width = 20
  config.use_fancy_tab_bar = false
  {{ if eq .chezmoi.os "darwin" -}}
  config.window_decorations = "RESIZE"
  {{ else -}}
  config.window_decorations = "NONE"
  {{ end -}}
end

return M
