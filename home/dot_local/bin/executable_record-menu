#!/bin/bash

codec="av1"
PID_FILE="/tmp/screen-recording.pid"
VIDEO_DIR="$HOME/video/captures"
mkdir -p "$VIDEO_DIR"

# Stop if already recording
if [[ -f "$PID_FILE" ]] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
    kill -SIGINT "$(cat "$PID_FILE")"
    rm -f "$PID_FILE"
    notify-send "Recording stopped" "Saved to $VIDEO_DIR"
    exit 0
fi

# Target menu
target=$(echo -e "Selection\nWindow\nFull Screen" | rofi -dmenu -p "Record")
[[ -z "$target" ]] && exit 0

sleep 0.15
timestamp=$(date +%Y%m%d-%H%M%S)
outfile="$VIDEO_DIR/$timestamp.webm"

case "$target" in
    "Selection")
        geometry=$(slop -f "%x %y %w %h") || exit 1
        read -r x y w h <<< "$geometry"
        gpu-screen-recorder -w region -region "${w}x${h}+${x}+${y}" -f 30 -k "$codec" -o "$outfile" &
        ;;
    "Window")
        gpu-screen-recorder -w "$(xdotool selectwindow)" -f 30 -k "$codec" -o "$outfile" &
        ;;
    "Full Screen")
        gpu-screen-recorder -w screen -f 30 -k "$codec" -o "$outfile" &
        ;;
esac

echo $! > "$PID_FILE"
notify-send "Recording started" "Press shortcut again to stop"

