#!/bin/bash
set -euo pipefail

# Configuration
readonly DATA="$HOME/.local/share/devcontainer"
readonly CONTAINER="ghcr.io/burnskp/containers/dev:latest"

if ! docker image inspect "$CONTAINER"  >/dev/null 2>&1; then
  echo "Image not found locally. Pulling $CONTAINER..."
  docker pull "$CONTAINER"
else
  docker pull "$CONTAINER" || true
fi

# Helper function to run docker container with common volumes
run_container() {
  docker run --rm -it \
    -v "$DATA:/data" \
    "$@"
}

# Handle file in a git repository
handle_git_file() {
  local target="$1"
  shift

  local git_root
  git_root="$(git -C "$(dirname "$(realpath "$target")")" rev-parse --show-toplevel)"
  local container_dir
  container_dir="$(basename "$git_root")"
  local abs_path
  abs_path="$(realpath "$target")"
  local rel_file="${abs_path#"$git_root"/}"

  run_container \
    -v "$git_root:/$container_dir" \
    "$CONTAINER" \
    "$@" "/$container_dir/$rel_file"
}

# Handle standalone file (not in git repository)
handle_standalone_file() {
  local target="$1"
  shift
  local filename="${target##*/}"

  run_container \
    -v "$(realpath "$target"):/work/$filename" \
    "$CONTAINER" \
    "$@" "/work/$filename"
}

# Handle git repository directory
handle_git_dir() {
  local workdir="$1"
  local container_dir
  container_dir="$(basename "$workdir")"
  shift

  run_container \
    -v "$workdir:/work/$container_dir" \
    "$CONTAINER" \
    "$@"
}

# Main logic
if [ $# -gt 0 ]; then
  target="${!#}"
  args=("${@:1:${#}-1}")

  # Create file if it doesn't exist and parent directory does
  if ! [ -e "$target" ] && [ -d "$(dirname "$target")" ]; then
    touch "$target"
  fi

  # Check if target is in a git repository
  if git -C "$(dirname "$(realpath "$target")")" rev-parse 2> /dev/null; then
    if [ -f "$target" ]; then
      handle_git_file "$target" "${args[@]}"
    fi
  elif [ -f "$target" ]; then
    handle_standalone_file "$target" "${args[@]}"
  else
    echo "Error: target '$target' is not a valid file or directory" >&2
    exit 1
  fi
elif git -C "$PWD" rev-parse 2> /dev/null; then
  # No target specified, use current directory if it's a git repo
  handle_git_dir "$PWD"
else
  echo "Error: not in a git repository and no file target specified" >&2
  exit 1
fi
