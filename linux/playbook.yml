---
- name: CachyOS System Setup
  hosts: localhost
  connection: local
  become: true
  vars:
    # User to configure (the user who invoked sudo, not root)
    target_user: "{{ lookup('env', 'SUDO_USER') | default(lookup('env', 'USER'), true) }}"

    # Kernel boot options (appended after root=UUID=... rw)
    kernel_options: "zswap.enabled=0 nowatchdog splash intel_iommu=on iommu=pt mitigations=off kernel.split_lock_mitigate=0 rcutree.enable_rcu_lazy=1 lsm=landlock,lockdown,yama,integrity,apparmor,bpf"

    flatpak_packages:
      - com.discordapp.Discord
      - com.fastmail.Fastmail
      - com.github.tchx84.Flatseal

    system_services:
      - apparmor
      - auditd
      - incus
      - keyd
      - power-profiles-daemon
      - tailscaled
      - ufw

    user_groups:
      - audio
      - incus
      - video

  tasks:
    - name: Update package cache and upgrade system
      pacman:
        update_cache: yes
        upgrade: yes

    - name: Install packages from packages.txt
      pacman:
        name: "{{ lookup('file', 'packages.txt').splitlines() }}"
        state: present

    - name: Ensure Flathub remote exists
      community.general.flatpak_remote:
        name: flathub
        state: present
        flatpakrepo_url: https://dl.flathub.org/repo/flathub.flatpakrepo

    - name: Install Flatpak applications
      community.general.flatpak:
        name: "{{ item }}"
        state: present
        remote: flathub
      loop: "{{ flatpak_packages }}"

    - name: Synchronize etc/ directory
      copy:
        src: etc/
        dest: /etc/
        owner: root
        group: root
        mode: preserve

    - name: Synchronize usr/ directory
      copy:
        src: usr/
        dest: /usr/
        owner: root
        group: root
        mode: preserve

    - name: Update kernel boot options (preserving UUID)
      lineinfile:
        path: /boot/loader/entries/linux-cachyos.conf
        regexp: '^options root=UUID=([a-f0-9-]+) rw.*'
        line: 'options root=UUID=\1 rw {{ kernel_options }}'
        backrefs: yes
      when: kernel_options is defined

    - name: Ensure intel-ucode initrd is present
      lineinfile:
        path: /boot/loader/entries/linux-cachyos.conf
        regexp: '^initrd /intel-ucode\.img'
        line: 'initrd /intel-ucode.img'
        insertbefore: '^initrd /initramfs-linux-cachyos\.img'

    - name: Add user to groups
      user:
        name: "{{ target_user }}"
        groups: "{{ user_groups }}"
        append: yes

    - name: Change user shell to zsh
      user:
        name: "{{ target_user }}"
        shell: /bin/zsh

    - name: Enable and start system services
      systemd:
        name: "{{ item }}"
        enabled: yes
        state: started
        daemon_reload: yes
      loop: "{{ system_services }}"
      register: service_results
      failed_when: false

    - name: Report any service failures
      fail:
        msg: "Service {{ item.item }} failed to start: {{ item.msg | default('unknown error') }}"
      loop: "{{ service_results.results }}"
      when: item.failed | default(false)
      ignore_errors: true
